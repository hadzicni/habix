<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/today"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ isNewHabit ? 'New Habit' : 'Edit Habit' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="content-wrapper">
    <ion-list>
      <!-- Title -->
      <ion-item
        [class.ion-invalid]="validationErrors['title'] && touched['title']"
        [class.ion-valid]="!validationErrors['title'] && touched['title'] && habit.title"
      >
        <ion-label position="stacked">Habit Name *</ion-label>
        <ion-input
          [(ngModel)]="habit.title"
          placeholder="e.g., Morning Exercise, Read 30 min"
          maxlength="50"
          (ionBlur)="onTitleBlur()"
          (ionInput)="validateTitle()"
          required
        ></ion-input>
        @if (validationErrors['title'] && touched['title']) {
        <ion-note slot="error" color="danger">{{ validationErrors['title'] }}</ion-note>
        } @if (!validationErrors['title'] && touched['title'] && habit.title) {
        <ion-note slot="helper" color="success">✓ Looks good!</ion-note>
        }
      </ion-item>

      <!-- Description -->
      <ion-item [class.ion-invalid]="validationErrors['description'] && touched['description']">
        <ion-label position="stacked">Description (Optional)</ion-label>
        <ion-textarea
          [(ngModel)]="habit.description"
          placeholder="Why is this habit important to you?"
          rows="3"
          maxlength="200"
          auto-grow="true"
          (ionBlur)="onDescriptionBlur()"
          (ionInput)="validateDescription()"
        ></ion-textarea>
        @if (validationErrors['description'] && touched['description']) {
        <ion-note slot="error" color="danger">{{ validationErrors['description'] }}</ion-note>
        } @if (habit.description) {
        <ion-note slot="helper">{{ habit.description.length }}/200 characters</ion-note>
        }
      </ion-item>

      <!-- Icon Selection -->
      <ion-item>
        <ion-label position="stacked">Choose an Icon</ion-label>
        <div class="icon-grid">
          @for (iconOption of availableIcons; track iconOption.name) {
          <div
            class="icon-option"
            [class.selected]="habit.icon === iconOption.name"
            (click)="selectIcon(iconOption.name)"
          >
            <ion-icon [name]="iconOption.name"></ion-icon>
          </div>
          }
        </div>
      </ion-item>

      <!-- Color Selection -->
      <ion-item>
        <ion-label position="stacked">Choose a Color</ion-label>
        <div class="color-grid">
          @for (colorOption of availableColors; track colorOption) {
          <div
            class="color-option"
            [style.background]="colorOption"
            [class.selected]="habit.color === colorOption"
            (click)="selectColor(colorOption)"
          >
            @if (habit.color === colorOption) {
            <ion-icon name="checkmark-circle"></ion-icon>
            }
          </div>
          }
        </div>
      </ion-item>

      <!-- Enable Reminder -->
      <ion-item>
        <ion-icon name="notifications-outline" slot="start"></ion-icon>
        <ion-label>Enable Reminder</ion-label>
        <ion-toggle [(ngModel)]="habit.reminder_enabled"></ion-toggle>
      </ion-item>

      <!-- Reminder Time -->
      @if (habit.reminder_enabled) {
      <ion-item
        [class.ion-invalid]="validationErrors['reminderTime'] && touched['reminderTime']"
        [class.ion-valid]="!validationErrors['reminderTime'] && touched['reminderTime'] && habit.reminder_time"
      >
        <ion-icon name="time-outline" slot="start"></ion-icon>
        <ion-label position="stacked">Reminder Time *</ion-label>
        <ion-input
          type="time"
          [(ngModel)]="habit.reminder_time"
          placeholder="HH:MM"
          (ionBlur)="onReminderTimeBlur()"
          (ionInput)="validateReminderTime()"
          required
        ></ion-input>
        @if (validationErrors['reminderTime'] && touched['reminderTime']) {
        <ion-note slot="error" color="danger">{{ validationErrors['reminderTime'] }}</ion-note>
        } @if (!validationErrors['reminderTime'] && touched['reminderTime'] && habit.reminder_time)
        {
        <ion-note slot="helper" color="success"
          >✓ Reminder will be sent at {{ habit.reminder_time }}</ion-note
        >
        }
      </ion-item>
      }

      <!-- Active Status -->
      <ion-item>
        <ion-label>Habit Active</ion-label>
        <ion-toggle [(ngModel)]="habit.is_active"></ion-toggle>
      </ion-item>
    </ion-list>

    <!-- Completion History (only for existing habits) -->
    @if (!isNewHabit && completions.length > 0) {
    <div class="history-section">
      <h3>Recent Completions</h3>
      <div class="completion-list">
        @for (completion of completions; track completion.id) {
        <div class="completion-item">
          <div class="completion-date">
            <ion-icon name="checkmark-circle"></ion-icon>
            {{ completion.formattedDate }}
          </div>
          @if (completion.notes) {
          <div class="completion-note">{{ completion.notes }}</div>
          }
        </div>
        }
      </div>
    </div>
    }

    <!-- Action Buttons -->
    <div class="action-buttons">
      <ion-button expand="block" (click)="saveHabit()" class="save-button">
        <ion-icon slot="start" name="save-outline"></ion-icon>
        {{ isNewHabit ? 'Create' : 'Save' }}
      </ion-button>

      @if (!isNewHabit) {
      <ion-button
        expand="block"
        color="danger"
        fill="outline"
        (click)="deleteHabit()"
        class="delete-button"
      >
        <ion-icon slot="start" name="trash-outline"></ion-icon>
        Delete
      </ion-button>
      }
    </div>
  </div>
</ion-content>
