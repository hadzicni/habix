<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Habix</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">{{ getTodayDate() }}</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="content-wrapper">
    <!-- Greeting Header -->
    <div class="greeting-header">
      <h1>{{ getGreeting() }}</h1>
      <p class="date-subtitle">{{ getTodayDate() }}</p>
    </div>

    <!-- Today's Progress Summary -->
    @if (todaysHabits$ | async; as habits) {
    <div class="progress-card">
      <div class="progress-header">
        <div class="progress-title">
          <h2>Today</h2>
          <p>{{ getCompletedCount(habits) }} of {{ habits.length }} completed</p>
        </div>
        <div class="progress-circle">
          <svg width="60" height="60">
            <circle
              cx="30"
              cy="30"
              r="26"
              stroke="rgba(102, 126, 234, 0.1)"
              stroke-width="4"
              fill="none"
            />
            <circle
              cx="30"
              cy="30"
              r="26"
              stroke="url(#gradient)"
              stroke-width="4"
              fill="none"
              [attr.stroke-dasharray]="getCircumference()"
              [attr.stroke-dashoffset]="getProgress(habits)"
              stroke-linecap="round"
              transform="rotate(-90 30 30)"
            />
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color: #667eea; stop-opacity: 1" />
                <stop offset="100%" style="stop-color: #764ba2; stop-opacity: 1" />
              </linearGradient>
            </defs>
          </svg>
          <span class="progress-percentage">{{ getProgressPercentage(habits) }}%</span>
        </div>
      </div>
    </div>
    }

    <!-- Habits List -->
    <div class="habits-section">
      <div class="section-header">
        <h3>My Habits</h3>
      </div>

      @for (habit of todaysHabits$ | async; track habit.id) {
      <ion-item-sliding #slidingItem>
        <ion-item lines="none" class="sliding-item">
          <div
            class="habit-card"
            [class.completed]="habit.completedToday"
            (click)="habit.completedToday ? null : editHabit(habit.id!)"
          >
            <!-- Habit Icon with Color -->
            @if (habit.icon) {
            <div class="habit-icon" [style.background]="habit.color || '#667eea'">
              <ion-icon [name]="habit.icon"></ion-icon>
            </div>
            }

            <div class="habit-checkbox">
              <ion-checkbox
                [checked]="habit.completedToday"
                [disabled]="habit.completedToday"
                (ionChange)="toggleHabitCompletion(habit, $event)"
                (click)="$event.stopPropagation()"
              ></ion-checkbox>
            </div>

            <div class="habit-content">
              <div class="habit-title">{{ habit.title }}</div>
              <div class="habit-meta">
                @if (habit.streak_count > 0) {
                <span class="habit-streak">
                  <ion-icon name="flame"></ion-icon>
                  {{ habit.streak_count }} days
                </span>
                } @if (habit.reminder_time) {
                <span class="habit-time">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ habit.reminder_time }}
                </span>
                }
              </div>
            </div>
          </div>
        </ion-item>

        <ion-item-options side="end">
          <ion-item-option color="danger" (click)="deleteHabit(habit.id!, slidingItem)">
            <ion-icon slot="icon-only" name="trash"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
      }

      <!-- Empty State -->
      @if ((todaysHabits$ | async)?.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <ion-icon name="checkbox-outline"></ion-icon>
        </div>
        <h3>No habits yet</h3>
        <p>Start your journey to better habits!</p>
      </div>
      }
    </div>
  </div>

  <!-- Floating Action Button -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openAddHabitAlert()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Add Habit Alert -->
  <ion-alert
    [isOpen]="isAlertOpen"
    header="New Habit"
    [inputs]="alertInputs"
    [buttons]="alertButtons"
  ></ion-alert>

  <!-- Note Alert -->
  <ion-alert
    [isOpen]="isNoteAlertOpen"
    header="Add Note"
    message="Would you like to add a note for this completion?"
    [inputs]="noteAlertInputs"
    [buttons]="noteAlertButtons"
    (didDismiss)="isNoteAlertOpen = false"
  ></ion-alert>

  <!-- Toast for notifications -->
  <ion-toast
    [isOpen]="isToastOpen"
    [message]="toastMessage"
    [duration]="3000"
    position="bottom"
    (didDismiss)="isToastOpen = false"
  ></ion-toast>
</ion-content>
